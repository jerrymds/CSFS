@model CTBC.CSFS.Models.CasePayeeSetting
@{
    ViewBag.Title = "_PayeeEdit";
    Layout = "~/Views/Shared/_Colorbox_Layout.cshtml";
}
<div class="margin">
    <div class="nav-tabs-custom">
        <div class="box box-primary">
            <div class="box-header">
                <i class="fa fa-edit"></i>
                <h3 class="box-title">@Lang.csfs_modify</h3>
            </div>
            @using (Html.BeginForm("_PayeeEdit", "AgentAccountInfo", new { area = "Agent" }, FormMethod.Post, new { id = "frmEditCPS", @class = "form-horizontal" }))
            {
                <div class="box-body">
                    <table id="query_table" class="table text-black no-border">
                        <tbody>
                            <tr>
                                <td class="col-md-1">@Lang.csfs_receive_person</td>
                                <td class="col-md-2">
                                    @Html.TextBoxFor(m => m.ReceivePerson, new { @MaxLength = "100" })
                                    <a href="@Url.Action("QueryGovAddress", "Home", new {area = "", CaseId = ViewBag.CaseId, @radom = DateTime.Now.ToString()})"
                                       class="fancy800_600 btn btn-default btn-xs">
                                        <li class="fa fa-search" id="aQueryPerson"></li>
                                    </a>
                                </td>
                                <td class="col-md-1"></td>
                                <td class="col-md-2"></td>
                            </tr>
                            <tr>
                                <td class="col-md-1">@Lang.csfs_receiver</td>
                                <td class="col-md-2">
                                    @Html.TextBoxFor(m => m.Receiver, new { @MaxLength = "50" })
                                    <a href="@Url.Action("QueryGovAddress", "Home", new {area = "", CaseId = ViewBag.CaseId, @radom = DateTime.Now.ToString()})"
                                       class="fancy800_600 btn btn-default btn-xs">
                                        <li class="fa fa-search" id="aQueryReceiver"></li>
                                    </a>
                                </td>
                                <td class="col-md-1">@Lang.csfs_address</td>
                                <td class="col-md-2">
                                    @Html.TextBoxFor(m => m.Address, new { @MaxLength = "100" })
                                </td>
                            </tr>
                            <tr>
                                <td class="col-md-1">@Lang.csfs_currency</td>
                                <td class="col-md-2">
                                    @Html.TextBoxFor(m => m.Currency, new { @MaxLength = "10" })
                                    <a href="@Url.Action("QueryGovAddress", "Home", new {area = "", CaseId = ViewBag.CaseId, @radom = DateTime.Now.ToString()})"
                                       class="fancy800_600 btn btn-default btn-xs">
                                        <li class="fa fa-search" id="aQueryCc"></li>
                                    </a>
                                </td>
                                <td class="col-md-1">@Lang.csfs_ccreceiver</td>
                                <td class="col-md-2">
                                    @Html.TextBoxFor(m => m.CCReceiver, new { @MaxLength = "100" })
                                </td>
                            </tr>
                            <tr>
                                <td class="col-md-1">@Lang.csfs_pay_amt1</td>
                                <td class="col-md-2">
                                    @Html.TextBoxFor(m => m.Money, new { @MaxLength = "35" })
                                </td>
                                <td class="col-md-1">@Lang.csfs_fee</td>
                                <td class="col-md-2">
                                    @Html.TextBoxFor(m => m.Fee, new { @MaxLength = "35" })
                                </td>
                            </tr>

                            <tr>
                                <td class="col-md-1">@Lang.csfs_case_unit</td>
                                <td class="col-md-5" colspan="3">
                                    @Html.TextBoxFor(m => m.Bank, new { @id = "Bank", @MaxLength = "100", @readonly = "readonly" })
                                </td>
                            </tr>
                            <tr>
                                <td class="col-md-1">@Lang.csfs_case_type</td>
                                <td class="col-md-2">
                                    @Html.TextBoxFor(m => m.CaseKind, new { @id = "CaseKind", @MaxLength = "10", @disabled = "true" })
                                </td>
                                <td class="col-md-1"></td>
                                <td class="col-md-2"></td>
                            </tr>
                            <tr>
                                <td class="col-md-1">@Lang.csfs_memo</td>
                                <td class="col-md-2">
                                    @Html.TextAreaFor(m => m.Memo, new { @MaxLength = "200", @rows = "3", @cols = "42" })
                                </td>
                                <td class="col-md-1"></td>
                                <td class="col-md-2"></td>
                            </tr>
                        </tbody>
                    </table>
                    @Html.HiddenFor(m => m.CheckIntervalId)
                    @Html.HiddenFor(m => m.PayeeId)
                    @Html.HiddenFor(m => m.PayAmountSum)
                    @Html.HiddenFor(m => m.MoneySum)
                    @Html.HiddenFor(m => m.SendId, new { @id = "SendId" })
                    @Html.HiddenFor(m => m.PayeeAction)
                </div>
                <div class="box-footer text-center">
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <button id="btnSaveEdit" type="button" class="btn btn-primary btn-xs">@Lang.csfs_meetSave</button>
                    <button id="btnCancelEdit" type="reset" class="btn btn-default btn-xs">@Lang.csfs_cancel</button>
                </div>

                <div class="box-body">
                    <table id="query_table" class="table text-black no-border">
                        <tbody>
                            <tr>
                                <td class="col-md-1">@Lang.csfs_check_no</td>
                                <td class="col-md-2">
                                    @Html.TextBoxFor(m => m.CheckNo, new { @id = "CheckNo", @MaxLength = "10", @readonly = "true" })
                                </td>
                                <td class="col-md-1" style="width:10%">
                                    <button id="btnSaveEditCreate" type="button" class="btn btn-primary btn-xs">@Lang.csfs_getticket@Lang.csfs_meetSave</button>
                                    <button id="btnSaveEditCancel" type="button" class="btn btn-primary btn-xs">@Lang.csfs_cancelticket@Lang.csfs_meetSave</button>
                                </td>
                                <td class="col-md-2"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>
@Html.Hidden("EditSuccessMsg", Lang.csfs_edit_ok)
@Html.Hidden("EditFailMsg", Lang.csfs_edit_fail)
@Html.Hidden("PlzInput", Lang.csfs_enter_parm0)
@Html.Hidden("MoneyIsNumber", Lang.csfs_money_is_number)
@Html.Hidden("PersonNotNull", Lang.csfs_receive_person)
@Html.Hidden("ReceiverNotNull", Lang.csfs_receiver)
@Html.Hidden("AddressNotNull", Lang.csfs_address)
@Html.Hidden("CurrencyNotNull", Lang.csfs_currency)
@Html.Hidden("CCReceiverNotNull", Lang.csfs_ccreceiver)
@Html.Hidden("MoneyMore", Lang.csfs_money_more)

<script src="~/Scripts/jquery-2.1.3.min.js"></script>

@Html.Hidden("GetGovNameUrl", Url.Action("GetGovNameByGoveKind", "Home", new { area = "" }))

<script type="text/javascript">
    var queryAddrType = "PERSON";

    jQuery(document).ready(function () {
        $.CSFS.bindGovKindAndUnit("ddlReceiver", "TxAddress");
        $("#aQueryPerson").click(function () { queryAddrType = "PERSON"; });
        $("#aQueryReceiver").click(function () { queryAddrType = "RECEIVER"; });
        $("#aQueryCc").click(function () { queryAddrType = "CC"; });

        $("#btnSaveEdit").click(function () { return btnSaveEditClick(1); });
        $("#btnSaveEditCreate").click(function () { return btnSaveEditClick(2); });
        $("#btnSaveEditCancel").click(function () { return btnSaveEditClick(3); });
        $("#btnCancelEdit").click(function () { return btnCancelEditClick(); });
        
        if ($("#CheckNo").val() === "") {
            $("#btnSaveEditCreate").prop("disabled", "");
        } else {
            $("#btnSaveEditCreate").prop("disabled", "disabled");
        }

    });

    function btnSaveEditClick(iAction) {
        trimAllInput();
        if (!ajaxValidate()) {
            return false;
        }

        $("#PayeeAction").val(iAction);
        $.blockUI();
        $.ajax({
            url: $("#frmEditCPS").attr("action"),
            type: "Post",
            cache: false,
            data: $("#frmEditCPS").serialize(),
            dataType: "json",
            error: function () {
                jAlertError($("#LoadErrorMsg").val());
                $.unblockUI();
            },
            success: function (data) {
                if (data.ReturnCode === "1") {
                    jAlertSuccess($("#EditSuccessMsg").val(), function () {
                        parent.$.colorbox.close();
                        parent.location = parent.$("#AccountPageUrl").val() + "&TabNo=3";
                    });
                } else {
                    jAlertError($("#EditFailMsg").val());
                    $.unblockUI();
                }

            }
        });
        return false;
    }

    //* 點擊取消
    function btnCancelEditClick() {
        parent.$.colorbox.close();
    }

    function ajaxValidate() {
        var newLine = "<br/>";
        var msg = "";
        if ($("#ReceivePerson").val().length <= 0) {
            msg = msg + $.validator.format($("#PlzInput").val(), $("#PersonNotNull").val()) + newLine;
        }
        if ($("#Receiver").val().length <= 0) {
            msg = msg + $.validator.format($("#PlzInput").val(), $("#ReceiverNotNull").val()) + newLine;
        }
        if ($("#Address").val().length <= 0) {
            msg = msg + $.validator.format($("#PlzInput").val(), $("#AddressNotNull").val()) + newLine;
        }
        var filter = /^([0-9.]+)$/;
        if (!filter.test($("#Money").val())) {
            msg = msg + $("#MoneyIsNumber").val() + newLine;
        }
        var monery = $("#Money").val();
        var fee = $("#Fee").val();
        if (fee === "") { fee = 0; }
        if ((parseInt(monery) + parseInt(fee)) > (parseInt($("#PayAmountSum").val().replace(/\,/g, "")) - parseInt($("#MoneySum").val().replace(/\,/g, "")))) {
            msg = msg + $("#MoneyMore").val() + newLine;
        }
        if (msg.length > 0) {
            jAlertError(msg);
            return false;
        }
        return true;
    }

    function addTr(govName, govAddr) {
        if (queryAddrType === "PERSON") {
            $("#ReceivePerson").val(govName);
            $("#Receiver").val(govName);
            $("#Address").val(govAddr);
        }
        if (queryAddrType === "RECEIVER") {
            $("#Receiver").val(govName);
            $("#Address").val(govAddr);
        }
        if (queryAddrType === "CC") {
            $("#Currency").val(govName);
            $("#CCReceiver").val(govAddr);
        }
    }

    function trimAllInput() {
        $(":input[type='text']").each(function () {
            $(this).val($.trim($(this).val()));
        });
    }

</script>
