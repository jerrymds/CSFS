@model CTBC.CSFS.Models.LendData
@{
    ViewBag.Title = Lang.csfs_menu_tit_originalinfoquery;
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<div class="box box-primary">
    <div class="box-header">
        <i class="glyphicon glyphicon-search"></i>
        <h3 class="box-title">@Lang.csfs_query</h3>
    </div>
    <!-- form start -->
    @using (Html.BeginForm("_QueryResult", "OriginalInfoQuery", new { area = "QueryAndExport" }, FormMethod.Post, new { id = "frmQuery", @class = "form-horizontal" }))
    {
        <div class="box-body ">
            <table class="table-noborder">
                <tbody>
                    <tr>
                        <td class="col-md-1 text-right">@Lang.csfs_case_kind</td>
                        <td class="col-md-5" colspan="5">
                            @Html.DropDownListFor(m => m.CaseKind, (IEnumerable<SelectListItem>)ViewBag.CaseKindList, Lang.csfs_select, new { @id = "ddlCaseKind" })
                            @Html.DropDownListFor(m => m.CaseKind2, (IEnumerable<SelectListItem>)ViewBag.CaseKind2List, Lang.csfs_select, new { @id = "ddlCaseKind2" })
                        </td>
                        @*<td class="col-md-1 text-right"></td>
                        <td class="col-md-3"></td>
                        <td class="col-md-1 text-right"></td>
                        <td class="col-md-3"></td>*@
                    </tr>
                    <tr>
                        <td class="col-md-1 text-right">@Lang.csfs_gov_name</td>
                        <td class="col-md-5">
                            @*@Html.DropDownListFor(m => m.GovKind, (IEnumerable<SelectListItem>)ViewBag.GOV_KINDList, Lang.csfs_select, new { @id = "ddlGOV_KIND1" })*@
                            @Html.TextBoxFor(m => m.GovUnit, new { @id = "txtGovUnit1", @MaxLength = "200" })
                        </td>
                        <td class="col-md-1 text-right">@Lang.csfs_case_no</td>
                        <td class="col-md-2">
                            @Html.TextBoxFor(m => m.CaseNo, new { @id = "txtDocNo" })
                        </td>
                        @*<td class="col-md-1 text-right"></td>
                        <td class="col-md-3"></td>*@
                    </tr>
                    <tr>
                        <td class="col-md-1 text-right">@Lang.csfs_gov_date</td>
                        <td class="col-md-5">
                            @Html.TextBoxFor(m => m.GovDateStart, new { @id = "txtGovNo1", data_datepicker = "true" })
                            ~
                            @Html.TextBoxFor(m => m.GovDateEnd, new { @id = "txtGovNo2", data_datepicker = "true" })
                        </td>
                        <td class="col-md-1 text-right">@Lang.csfs_case_speed</td>
                        <td class="col-md-2">
                            @Html.DropDownListFor(m => m.Speed, (IEnumerable<SelectListItem>)ViewBag.SpeedList, Lang.csfs_select, new { @id = "ddlSpeed" })
                        </td>
                        <td class="col-md-1 text-right">@Lang.csfs_receive_kind</td>
                        <td class="col-md-2">
                            @Html.DropDownListFor(m => m.ReceiveKind, (IEnumerable<SelectListItem>)ViewBag.ReceiveKindList, Lang.csfs_select, new { @id = "ddlReceiveKind" })
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-1 text-right">@Lang.csfs_gov_no</td>
                        <td class="col-md-5">
                            @Html.TextBoxFor(m => m.GovNo, new { @id = "txtGovNo" })
                        </td>
                        @*<td class="col-md-1 text-right"></td>
                        <td class="col-md-3"></td>
                        <td class="col-md-1 text-right"></td>
                        <td class="col-md-3"></td>*@
                    </tr>
                    <tr>
                        @*20170811 RC RQ-2015-019666-020 派件至跨單位 宏祥 update start*@
                        @*<td class="col-md-1 text-right">@Lang.csfs_agnet</td>*@
                        @*<td class="col-md-3">*@
                            @*@Html.TextBoxFor(m => m.AgentUser, new { @id = "txtAgentUser" })*@
                            @*@Html.DropDownListFor(m => m.AgentUser, (IEnumerable<SelectListItem>)ViewBag.AgentUserList, Lang.csfs_select, new { @id = "ddlAgentUser" })*@
                        @*</td>*@
                        <td class="col-md-1 text-right">@Lang.csfs_LendStatus</td>
                        <td class="col-md-5">
                            @Html.DropDownListFor(m => m.LendStatus, (IEnumerable<SelectListItem>)ViewBag.LendStatusList, Lang.csfs_select, new { @id = "ddlLendStatus" })
                        </td>
                        @*20170811 RC RQ-2015-019666-020 派件至跨單位 宏祥 update end*@
                        <td class="col-md-1 text-right">@Lang.csfs_clientID</td>
                        <td class="col-md-2">
                            @Html.TextBoxFor(m => m.ClientID, new { @id = "txtLendId" })
                        </td>
                        @*<td class="col-md-1 text-right"></td>
                        <td class="col-md-3"></td>*@
                    </tr>
                    <tr>
                        @*20170811 RC RQ-2015-019666-020 派件至跨單位 宏祥 add start*@
                        <td class="col-md-1 text-right">@Lang.csfs_agnet</td>
                        <td class="col-md-5">
                            @Html.DropDownListFor(m => m.AgentDepartment, (IEnumerable<SelectListItem>)ViewBag.AgentDepartmentList, Lang.csfs_select, new { @id = "ddlAgentDepartment" })
                            @Html.DropDownListFor(m => m.AgentDepartment2, (IEnumerable<SelectListItem>)ViewBag.AgentDepartment2List, Lang.csfs_select, new { @id = "ddlAgentDepartment2" })
                            @Html.DropDownListFor(m => m.AgentDepartmentUser, (IEnumerable<SelectListItem>)ViewBag.AgentDepartmentUserList, Lang.csfs_select, new { @id = "ddlAgentDepartmentUser" })
                        </td>                        
                        @*<td class="col-md-1 text-right"></td>*@
                        @*<td class="col-md-3"></td>*@
                        @*<td class="col-md-1 text-right"></td>*@
                        @*<td class="col-md-3"></td>*@
                        @*20170811 RC RQ-2015-019666-020 派件至跨單位 宏祥 add end*@
                    </tr>
                </tbody>
            </table>
        </div>
    <input type="hidden" id="pageNum" name="pageNum" />
        <div class="box-footer text-center">
            <button id="btnQuery" type="button" class="btn btn-primary btn-xs">@Lang.csfs_query</button>
            <button id="btnCancel" type="reset" class="btn btn-default btn-xs">@Lang.csfs_cancel</button>
        </div>
    }
    <div id="divResult" class="table-wrap" data-target-url="@Url.Action("_QueryResult", "OriginalInfoQuery", new { area = "QueryAndExport" })">

    </div>
</div>
<iframe id="upload_frame" name="upload_frame" src="" class="hidden"></iframe>
@Html.Hidden("SyncAuthUrl", Url.Action("ChangCaseKind", "OriginalInfoQuery", new { area = "QueryAndExport" }))
@Html.Hidden("PleaseSelect", Lang.csfs_select)
@Html.Hidden("NametxtDate1", Lang.csfs_date5)
@Html.Hidden("NametxtDate2", Lang.csfs_date6)
@Html.Hidden("isQuery", (string)ViewBag.isQuery)
@Html.Hidden("CaseKind2Query", (string)ViewBag.CaseKind2Query)
@Html.Hidden("CurrentPage", (string)ViewBag.CurrentPage)

@* 20170811 RC RQ-2015-019666-020 派件至跨單位 宏祥 add start *@
@Html.Hidden("GetAgentDepartment2Url", Url.Action("ChangAgentDepartment1", "CollectionToAgent", new { area = "Collection" }))
@Html.Hidden("GetAgentDepartmentUserUrl", Url.Action("ChangAgentDepartment2", "CollectionToAgent", new { area = "Collection" }))
@* 20170811 RC RQ-2015-019666-020 派件至跨單位 宏祥 add end *@

@* 20171103 RC RQ-2015-019666-003 系統功能修正 宏祥 update start *@
@Html.Hidden("AgentDepartment2Query", (string)ViewBag.AgentDepartment2Query)
@Html.Hidden("AgentDepartmentUserQuery", (string)ViewBag.AgentDepartmentUserQuery)
@* 20171103 RC RQ-2015-019666-003 系統功能修正 宏祥 update end *@

@section scripts {
    @* 來文機關聯動 start*@
    <script src="~/Scripts/bootstrap-typeahead.js"></script>
    @Html.Hidden("GetGovNameUrl", Url.Action("GetGovNameByGoveKind", "Home", new { area = "" }))
    @* 來文機關聯動 end *@
 
    <script type="text/javascript">
        $.CSFS.bindGovKindAndUnit1("txtGovUnit1");
        //二級連動
        $('#ddlCaseKind2').attr("disabled", "true");
        //點擊來文機關選擇
        $("#ddlCaseKind").change(function () {
            changeCaseKind();
        });
        function changeCaseKind() {
            try {
                var selectedValue = $('#ddlCaseKind option:selected').val();
                if (selectedValue == "") {
                    $('#ddlCaseKind2').attr("disabled", "true");
                    $("#ddlCaseKind2").empty();
                    $("#ddlCaseKind2").append($('<option></option>').val('').text($("#PleaseSelect").val()));
                } else {
                    if ($.trim(selectedValue).length > 0) {
                        $.ajax({
                            type: "POST",
                            async: false,
                            url: $("#SyncAuthUrl").val(),
                            data: { caseKind: selectedValue },
                            success: function (data) {
                                if (data.length > 0) {
                                    $("#ddlCaseKind2").removeAttr("disabled");
                                    $("#ddlCaseKind2").empty();
                                    $("#ddlCaseKind2").append($('<option></option>').val('').text($("#PleaseSelect").val()));
                                    $.each(data, function (i, item) {
                                        $("#ddlCaseKind2").append($('<option></option>').val(item.Key).text(item.Value));
                                    });
                                } else {
                                    $("#ddlCaseKind2").attr("disabled", "true");
                                    $("#ddlCaseKind2").empty();
                                    $("#ddlCaseKind2").append($('<option></option>').val('').text($("#PleaseSelect").val()));
                                }
                            }
                        });
                    }
                }
            }
            catch (e) {
            }
        }

        //20170811 RC RQ-2015-019666-020 派件至跨單位 宏祥 add start
        $("#ddlAgentDepartment2").prop("disabled", "disabled");
        $("#ddlAgentDepartmentUser").prop("disabled", "disabled");
        //* 經辦人員
        $("#ddlAgentDepartment").change(function () { changeAgentDepartment(); });
        $("#ddlAgentDepartment2").change(function () { changeAgentDepartment2(); });
        //20170811 RC RQ-2015-019666-020 派件至跨單位 宏祥 add end

        if ($("#isQuery").val() == "1") {
            changeCaseKind();
            $("#pageNum").val(parseInt($("#CurrentPage").val()));
            $("#ddlCaseKind2").val($("#CaseKind2Query").val());
            //20171103 RC RQ-2015-019666-003 系統功能修正 宏祥 update start
            changeAgentDepartment();
            $("#ddlAgentDepartment2").removeAttr("disabled");
            $("#ddlAgentDepartment2").val($("#AgentDepartment2Query").val());
            changeAgentDepartment2();
            $("#ddlAgentDepartmentUser").removeAttr("disabled");
            $("#ddlAgentDepartmentUser").val($("#AgentDepartmentUserQuery").val());
            //20171103 RC RQ-2015-019666-003 系統功能修正 宏祥 update end
            btnQueryClick();
        }

        $("#btnQuery").click(function () { return btnQueryClick();})

        function btnQueryClick() {
            var newLine = "<br/>";
            var msg = "";
            if (!checkIsValidDate($("#txtGovNo1").val())) {
                msg = msg + $("#NametxtDate1").val() + newLine;
            }
            if (!checkIsValidDate($("#txtGovNo2").val())) {
                msg = msg + $("#NametxtDate2").val() + newLine;
            }
            //* 有必填檢核錯誤
            if (msg.length > 0) {
                jAlertError(msg);
                return false;
            }

            $.blockUI();
            $.ajax({
                url: $("#frmQuery").attr("action"),
                type: "Post",
                cache: false,
                data: $("#frmQuery").serialize(),
                error: function () {
                    jAlertError($("#LoadErrorMsg").val());
                    $.unblockUI();
                },
                success: function (data) {
                    $("#divResult").html(data).show();
                    $.unblockUI();
                    $("#querystring").val($("#frmQuery").serialize());
                }
            });
        }

        //20170811 RC RQ-2015-019666-020 派件至跨單位 宏祥 add start
        //* 經辦人員下拉(處)    
        function changeAgentDepartment() {
            try {
                $("#ddlAgentDepartmentUser").attr("disabled", "true");
                $("#ddlAgentDepartmentUser").empty();
                $("#ddlAgentDepartmentUser").append($("<option></option>").val('').text($("#PleaseSelect").val()));
                var selectedValue = $("#ddlAgentDepartment option:selected").val();
                if (selectedValue === "") {
                    $("#ddlAgentDepartment2").attr("disabled", "true");
                    $("#ddlAgentDepartment2").empty();
                    $("#ddlAgentDepartment2").append($("<option></option>").val("").text($("#PleaseSelect").val()));
                } else {
                    if ($.trim(selectedValue).length > 0) {
                        $.ajax({
                            type: "POST",
                            async: false,
                            url: $("#GetAgentDepartment2Url").val(),
                            data: { AgentDepartment: selectedValue },
                            success: function (data) {
                                if (data.length > 0) {
                                    $("#ddlAgentDepartment2").removeAttr("disabled");
                                    $("#ddlAgentDepartment2").empty();
                                    $("#ddlAgentDepartment2").append($("<option></option>").val('').text($("#PleaseSelect").val()));
                                    $.each(data, function (i, item) {
                                        $("#ddlAgentDepartment2").append($("<option></option>").val(item.Value).text(item.Value));
                                    });
                                } else {
                                    $("#ddlAgentDepartment2").attr("disabled", "true");
                                    $("#ddlAgentDepartment2").empty();
                                    $("#ddlAgentDepartment2").append($("<option></option>").val('').text($("#PleaseSelect").val()));
                                }
                            }
                        });
                    }
                }
            }
            catch (e) {
            }
        }
        //* 經辦人員下拉(科組)
        function changeAgentDepartment2() {
            try {
                var selectedValue = $("#ddlAgentDepartment2 option:selected").val();
                if (selectedValue === "") {
                    $("#ddlAgentDepartmentUser").attr("disabled", "true");
                    $("#ddlAgentDepartmentUser").empty();
                    $("#ddlAgentDepartmentUser").append($("<option></option>").val("").text($("#PleaseSelect").val()));
                } else {
                    if ($.trim(selectedValue).length > 0) {
                        $.ajax({
                            type: "POST",
                            async: false,
                            url: $("#GetAgentDepartmentUserUrl").val(),
                            data: { AgentDepartment: selectedValue },
                            success: function (data) {
                                if (data.length > 0) {
                                    $("#ddlAgentDepartmentUser").removeAttr("disabled");
                                    $("#ddlAgentDepartmentUser").empty();
                                    $("#ddlAgentDepartmentUser").append($("<option></option>").val('').text($("#PleaseSelect").val()));
                                    $.each(data, function (i, item) {
                                        $("#ddlAgentDepartmentUser").append($("<option></option>").val(item.Value).text(item.Value));
                                    });
                                } else {
                                    $("#ddlAgentDepartmentUser").attr("disabled", "true");
                                    $("#ddlAgentDepartmentUser").empty();
                                    $("#ddlAgentDepartmentUser").append($("<option></option>").val('').text($("#PleaseSelect").val()));
                                }
                            }
                        });
                    }
                }
            }
            catch (e) {
            }
        }
        //20170811 RC RQ-2015-019666-020 派件至跨單位 宏祥 add end
    </script>
}
